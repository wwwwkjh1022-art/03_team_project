"""
===========================================================
Part 1 — 데이터 전처리 환경 구성 & 라이브러리 선택 이유
===========================================================

본 파일은 알약 이미지 기반 YOLO 물체 탐지 프로젝트에서
데이터 전처리 과정을 진행하기 위한 라이브러리 선택 이유와
각 선택이 전처리에 어떤 영향을 주는지 정리한 문서입니다.

"""

# ---------------------------------------------------------
# 1. Pillow 선택 이유 (이미지 로딩 및 기본 처리)
# ---------------------------------------------------------
"""
• Pillow는 이미지 로딩, RGB 변환, 사이즈 확인, bbox 그리기 등
  전처리 단계의 기본 작업을 가장 안정적으로 수행할 수 있다.

• OpenCV와 달리 색상 채널 변환(BGR→RGB)을 신경쓸 필요가 없으며
  가벼운 시각화 및 디버깅 작업에 적합하다.

• 프로젝트 초기 시각적 테스트(샘플 이미지 + annotation 검증)에
  최적화된 라이브러리이며 Mac/MPS 환경에서도 완전 호환된다.
"""

from PIL import Image


# ---------------------------------------------------------
# 2. matplotlib 선택 이유 (이미지 시각화)
# ---------------------------------------------------------
"""
• 전처리 과정에서는 이미지와 bounding box를 정확하게 확인하는 것이 핵심이다.

• matplotlib은 Jupyter 노트북/Colab 환경에서 이미지 시각화를 하는
  가장 표준적이고 간단한 도구이다.

• 시각화를 통해 annotation 오류 여부를 빠르게 확인할 수 있으며
  전처리 품질 관리에 매우 유용하다.
"""

import matplotlib.pyplot as plt


# ---------------------------------------------------------
# 3. pathlib 선택 이유 (파일 경로 관리)
# ---------------------------------------------------------
"""
• pathlib은 Python 3의 표준 path 관리 라이브러리로,
  파일 및 폴더 구조를 객체지향적이고 가독성 높게 다룰 수 있다.

• glob보다 직관적이며, Mac/Windows/Linux 환경에서 코드가 동일하게 동작한다.

• JSON-이미지 매칭, 디렉토리 탐색 등 전처리 작업을 모듈화하기 좋다.
"""

from pathlib import Path


# ---------------------------------------------------------
# 4. Albumentations 선택 이유 (고급 데이터 증강)
# ---------------------------------------------------------
"""
• Albumentations는 YOLO 프로젝트들과 특히 궁합이 좋다.

• bounding box와 이미지가 함께 변환되도록 안전한 구조를 제공하며,
  색상 변화, 라이트 노이즈, 랜덤 확대/축소 등 다양한 augmentation을 지원한다.

• torchvision.transforms보다 옵션이 훨씬 다양하고,
  실제 산업 모델에서 사용되는 변환 대부분을 제공한다.

• 데이터 다양성 증가 → 모델 성능 향상 → 오버피팅 감소 효과
"""

import albumentations as A


"""
===========================================================
Part 2 — 데이터 구조 분석 & JSON 매칭 설계
===========================================================

"""


# ----------------------------------------------------------
# 2.1 데이터 디렉토리 구조 분석
# ----------------------------------------------------------
"""
전처리의 첫 단계는 이미지 폴더와 annotation 폴더의 전체 구조를
파악하는 것이다.

본 프로젝트 데이터셋의 특징:

1) train_images/
   - 파일명 예:
     K-003351-033880-038162_0_2_0_2_70_000_200.png
   - 약품 코드 3개 + 촬영 설정(각도, 조명 등)이 포함되어 있어
     파일명만으로 라벨(JSON)을 직접 매칭하기 어렵다.

2) train_annotations/
   - 파일명 예:
     K-003351-020238-033880__json
   - 약품 코드 2~3개 조합으로 구성되어 있으며
     확장자가 .json 이 아니라 __json 형태도 있다.
   - JSON 파일명만 보고 이미지 파일명을 즉시 추정할 수 없다.

데이터 구조 분석의 목적:
- 파일명 패턴 파악
- 누락/이상 데이터 확인
- JSON 매칭 전략 설계를 위한 기반 정보 확보
"""


# ----------------------------------------------------------
# 2.2 JSON Annotation 구조 분석 (COCO 형식)
# ----------------------------------------------------------
"""
각 annotation 파일은 COCO 형식 구조를 따른다.

COCO 구조 핵심 요소:
- images: 이미지 파일명, width/height, image_id 포함
- annotations: COCO bbox [xmin, ymin, width, height] 포함
- categories: category_id와 약품 이름 포함

핵심 분석 포인트:
1) bbox는 COCO 형식 → 추후 YOLO 형식으로 변환 필요
2) annotation은 image_id 기반 → JSON 파일명과 무관
3) JSON 파일명과 이미지 파일명이 직접 매칭되지 않음
"""


# ----------------------------------------------------------
# 2.3 이미지 ↔ JSON 파일 매칭 전략 (핵심)
# ----------------------------------------------------------
"""
데이터 구조 분석 결과, 이미지와 JSON 파일은 이름이 동일하지 않으므로
1:1 직접 매칭이 불가능하다.

문제점:
- 이미지 파일명은 약품 코드 3개 + 촬영 조건을 포함
- JSON 파일명은 약품 코드 2~3개 조합만 포함
- 확장자 규칙도 일반적이지 않음

따라서 매칭 전략 설계가 필요하다.

매칭 전략(핵심 원리):
- 이미지 파일명에서 약품 코드 리스트를 추출한다.
- JSON 파일명에서도 약품 코드 리스트를 추출한다.
- 두 리스트에 '하나라도 공통되는 코드'가 있으면 매칭 성공으로 간주한다.

이 전략이 중요한 이유:
- 실제 데이터셋 구조가 이미지/JSON 간 1:1 대응이 아님
- 약품 코드 조합으로만 관계가 성립되는 구조
"""


# ----------------------------------------------------------
# 2.4 매칭 함수 개념 설계
# ----------------------------------------------------------
"""
매칭 알고리즘이 수행해야 할 개념적 절차:

1) 이미지 파일명에서 약품 코드 추출
   - 파일명 규칙의 앞부분에서 코드 3개가 포함됨

2) annotation 디렉토리의 모든 JSON 파일명을 스캔

3) JSON 파일명에서 약품 코드 추출

4) 이미지 코드 리스트와 JSON 코드 리스트를 비교
   → 하나라도 공통되는 코드가 있으면 그 JSON을 해당 이미지의 annotation으로 선택

이 방식은 본 데이터셋의 라벨 구조를 고려한 최적의 매칭 방법이다.
"""


# ----------------------------------------------------------
# 2.5 bbox 시각화 검증 (Annotation Integrity Check)
# ----------------------------------------------------------
"""
전처리에서 가장 중요한 단계는 실제 이미지에 bounding box를
시각적으로 그려보는 것이다.

이 검증의 목적:
- annotation이 정확한 위치에 있는지 확인
- bbox가 잘못되었는지(좌표 오류, 크기 오류) 식별
- JSON 매칭이 정확히 이루어졌는지 테스트
- 전처리 안정성 확보

bbox 시각화는 학습 전 반드시 수행해야 하는 품질 검증 단계이며
다음 단계인 YOLO 변환에서도 오류를 미리 방지하게 된다.
"""


"""
===========================================================
Part 3 Annotation 변환(COCO → YOLO) 협업 공유용 문서
"""

# ============================================================
# 3.1 COCO 어노테이션 구조 핵심 요약
# ============================================================
"""
각 JSON 파일은 COCO 구조를 따른다:

images:
    - file_name
    - width / height
    - id (image_id)

annotations:
    - bbox: [x_min, y_min, w, h]  (픽셀 단위)
    - category_id
    - image_id

categories:
    - id
    - name

중요:
- bbox는 왼쪽 위 기준
- width, height가 절대 픽셀 단위
- YOLO 형식으로 변환하려면 중심(cx, cy) + 정규화 필요
"""

# ============================================================
# 3.2 YOLO 형식 요약
# ============================================================
"""
YOLO의 bbox 형식:
    class_id  cx  cy  w  h

모두 0~1 사이의 값이어야 하며,
이미지 전체 크기를 기준으로 정규화한다.

cx, cy = 박스 중심점 좌표 (정규화)
w, h   = 박스 크기 (정규화)
"""

# ============================================================
# 3.3 COCO → YOLO 변환 공식 (팀 공통 규칙)
# ============================================================
"""
주어진 COCO bbox = [x_min, y_min, bw, bh]
이미지 크기 = (W, H)

변환 공식:

cx = (x_min + bw/2) / W
cy = (y_min + bh/2) / H
w  = bw / W
h  = bh / H
"""

# ============================================================
# 3.4 클래스 매핑 정책
# ============================================================
"""
category_id 그대로 사용
"""

# ============================================================
# 3.5 변환 후 저장 규칙
# ============================================================
"""
폴더 구조 제안:

yolo_labels/
    ├── train/
    ├── val/
    └── test/

각 라벨 파일은 .txt 형식
한 이미지에 여러 bbox가 있을 경우, txt 파일에 여러 줄 기록
"""

# ============================================================
# 3.6 품질 검증 방법
# ============================================================
"""
COCO → YOLO 변환 후 반드시 최소 20개 샘플에 대해 검증한다.

검증 항목:
1) bbox 위치가 실제 약 위치와 동일한가?
2) 정규화 값이 0~1 범위를 벗어나지 않았는가?
3) class_id 매핑이 맞는가?
4) JSON → YOLO 파일명이 정상적으로 대응되는가?
"""

"""
Part 4 Transforms & Data Augmentation 협업 공유용 문서
"""

# ============================================================
# 4.1 Transform vs Augmentation 
# ============================================================
"""
Transform = 필수 전처리
    - Resize
    - Normalize
    - Tensor 변환(채널 순서 변경 포함)

Augmentation = 데이터 다양성 증가를 위한 랜덤 변형
    - 밝기/대비 조절, 회전, 좌우반전, 노이즈 추가 등

Train = Transform + Augmentation
Val/Test = Transform만
"""

# ============================================================
# 4.2 왜 알약 데이터에서 증강이 중요한가?
# ============================================================
"""
1) 데이터 수 부족 → 인위적 데이터 증가 효과
2) 각도·조명·위치 변화에 대한 강인성(Robustness) 증가
3) 과적합(overfitting) 방지
4) 실제 사용자 환경에서 다양한 촬영 조건을 반영할 수 있음
"""

# ============================================================
# 4.3 Albumentations를 선택하는 이유
# ============================================================
"""
- bbox-aware augmentation을 지원 (YOLO 필수)
- 빠르고 기능이 다양함
- 이미지 + bbox + 클래스 라벨을 함께 변형 가능

우리 프로젝트에서는 bbox가 반드시 동기화되어야 하므로
Albumentations가 가장 적합한 선택
"""

# ============================================================
# 4.4 추천 증강 리스트 (알약 데이터 특화)
# ============================================================
"""
1) 밝기/조명 변형
    - RandomBrightnessContrast

2) 기하학 변형
    - HorizontalFlip

3) 노이즈/흐림
    - MotionBlur

4) 위치 변형 (Safe Crop)
    - BboxSafeCrop

5) 규제 기반 증강 (약하게)
    - Cutout / RandomErasing

증강의 강도는 Level 1~3로 구성하여 조절 가능
"""

# ============================================================
# 4.5 클래스 불균형 해결을 위한 증강 정책
# ============================================================
"""
옵션 C — 클래스별 목표 수 설정 후 부족한 만큼만 증강  
"""

# ============================================================
# 4.6 bbox-aware Augmentation 필수 조건
# ============================================================
"""
YOLO bbox는 반드시 이미지 변환과 함께 이동해야 한다.

따라서 augmentation pipeline에는 아래 설정을 반드시 넣어야 한다:

bbox_params = A.BboxParams(
    format="yolo",
    label_fields=["class_labels"]
)

이 설정이 없으면 bbox가 어긋나서 학습 품질이 크게 떨어짐.
"""

# ============================================================
# 4.7 Transform (Val/Test 공통)
# ============================================================
"""
필수 Transform:
- Resize(224x224)
- Normalize
- ToTensor

Val/Test에서는 augmentation 금지.
"""


